# Upgrade to Symfony v7

Symfony has just released [Symfony 7.0](https://symfony.com/blog/symfony-7-0-0-released), there are a lot of breaking changes introduced in this version.

In this post, we will use [Symfony Rest Example](https://github.com/hantsy/symfony-rest-sample/t) as example, and explain how I upgrade to v7 step by step. 


## Backup The Existing Codes

Firstly, let's back up the project and tag the existing codes into an archive. 

```bash
git tag v6.x
git push origin v6.x
```
For those still use Symfony, please check the tag `v6.x` or download a copy from the [project tag list](https://github.com/hantsy/symfony-rest-sample/tags). 

Create a new branch to prepare the upgrading work.

```bash
git checkout -b v7
```

## Upgrade Symfony Packages to v7

Open the project in an IDE(PHPStorm or NetBeans IDE) or VSCode with PHP support.

Open `composer.json` file, change all symfony packages version to `7.0.*`.

```json
{
  "name": "hantsy/symfony-rest-sample",
  "description": "Restful APIs examples built with Symfony 7 and PHP 8",
  "authors": [
    {
      "name": "Hantsy Bai",
      "email": "hantsy@gmail.com"
    }
  ],
  "type": "project",
  "license": "GPL-3.0-or-later",
  "minimum-stability": "stable",
  "prefer-stable": true,
  "require": {
    "php": ">=8.2",
    "ext-ctype": "*",
    "ext-iconv": "*",
    "composer/package-versions-deprecated": "^1.11.99.4",
    "doctrine/annotations": "^2.0",
    "doctrine/doctrine-bundle": "^2.4",
    "doctrine/doctrine-migrations-bundle": "^3.1",
    "doctrine/orm": "^2.9",
    "phpdocumentor/reflection-docblock": "^5.2",
    "symfony/asset": "7.0.*",
    "symfony/console": "7.0.*",
    "symfony/dotenv": "7.0.*",
    "symfony/expression-language": "7.0.*",
    "symfony/flex": "^2.0.1",
    "symfony/framework-bundle": "7.0.*",
    "symfony/monolog-bundle": "^3.7",
    "symfony/property-access": "7.0.*",
    "symfony/property-info": "7.0.*",
    "symfony/runtime": "7.0.*",
    "symfony/serializer": "7.0.*",
    "symfony/uid": "7.0.*",
    "symfony/validator": "7.0.*",
    "symfony/yaml": "7.0.*"
  },
  "config": {
    "optimize-autoloader": true,
    "preferred-install": {
      "*": "dist"
    },
    "allow-plugins": true,
    "sort-packages": true
  },
  "autoload": {
    "psr-4": {
      "App\\": "src/"
    }
  },
  "autoload-dev": {
    "psr-4": {
      "App\\Tests\\": "tests/"
    }
  },
  "replace": {
    "symfony/polyfill-ctype": "*",
    "symfony/polyfill-iconv": "*",
    "symfony/polyfill-php72": "*"
  },
  "scripts": {
    "auto-scripts": {
      "cache:clear": "symfony-cmd",
      "assets:install %PUBLIC_DIR%": "symfony-cmd"
    },
    "post-install-cmd": [
      "@auto-scripts"
    ],
    "post-update-cmd": [
      "@auto-scripts"
    ],
    "test": "php bin/phpunit"
  },
  "conflict": {
    "symfony/symfony": "*"
  },
  "extra": {
    "symfony": {
      "allow-contrib": false,
      "require": "7.0.*"
    }
  },
  "require-dev": {
    "dama/doctrine-test-bundle": "^8.0",
    "doctrine/doctrine-fixtures-bundle": "^3.4",
    "phpunit/phpunit": "^9.5",
    "symfony/browser-kit": "7.0.*",
    "symfony/css-selector": "7.0.*",
    "symfony/maker-bundle": "^1.34",
    "symfony/phpunit-bridge": "7.0.*"
  }
}
```

We remove `sensio/framework-extra-bundle` and `nelmio/cors-bundle` from the package list. The former is deprecated in v7 and not recommended in new projects. The later does not release a Symfony v7 compatible version at the moment.

Remove `composer.json.lock`, and run `composer install` to install new packages and rerun the built-in recipes for this project.

## Refresh Codes

There are a few APIs that need to update. 

Firstly, we used `ArgumentResolver` in `sensio/framework-extra-bundle` to convert parameter to `Uuid`, in Symfony v7, the `ValueResolver` is the replacement. More details please check [Extending Action Argument Resolving](https://symfony.com/doc/current/controller/value_resolver.html#adding-a-custom-value-resolver). 

There is a built-in [UidValueResolver](https://github.com/symfony/symfony/blob/7.0/src/Symfony/Component/HttpKernel/Controller/ArgumentResolver/UidValueResolver.php) can be used to convert the parameter to `Uuidv4`. 

1. Simply remove the existing `App\ArgumentResolver\QueryParamValueResolver`. 
2. And remove the declaration in the `config/services.yaml`.
   
   ```yaml
    App\ArgumentResolver\QueryParamValueResolver:
      tags:
        - { name: controller.argument_value_resolver, priority: 50 }
   ```
Next, let's update the `BodyValueResolver` and `QueryParamValueResolver`. The original `ArgumentValueResolverInterface` is removed in v7, the replacement is `ValueResolverInterface`, which is similar to the old `ArgumentValueResolverInterface`, but there is no `supports` method to override.

We adjust the existing codes slightly to make it work seamlessly.

```php
class QueryParamValueResolver implements ValueResolverInterface, LoggerAwareInterface
{
    public function __construct()
    {
    }

    private LoggerInterface $logger;

    /**
     * @inheritDoc
     */
    public function resolve(Request $request, ArgumentMetadata $argument): iterable
    {
        if (!$this->supports($request, $argument)) return [];
        ...
    }    
```

We reuse `supports` method to determine if skip the execution of argument resolving. Similarly, we adjust the `BodyValueResolver` as expected.

Rerun `composer install`, we get the following error.

```bash
!!  In Loader.php line 63:
!!                                                                                 
!!    Cannot load resource "../../src/Controller/". Make sure there is a loader   
!!    supporting the "annotation" type.   
```

We should use the new attributes config to replace the legacy annotations config in controllers. 

1. Remove `config/routes/annotations.yaml`.
2. Create a new file `config/routes/attributes.yaml`, fill the following content.

    ```yaml
    controllers:
        resource:
            path: ../../src/Controller/
            namespace: App\Controller
        type: attribute

    kernel:
        resource: App\Kernel
        type: attribute
    ```

More information about Route, check [Creating Routes as Attributes](https://symfony.com/doc/current/routing.html#creating-routes-as-attributes).

Now the `composer install` command should be executed successfully.

When running the tests, there are several deprecated warning info.

The `Get`, `Post`, `Put`, `Delete` that we created as examples of annotations raise a warning like *the base `Route` could be final in future*. Thus means in a further version, our custom annotations will not work.

1. Remove the entire `src\Annotations` folder.
2. Open the `PostController`, use original `Route` attribute instead.

Note, if you use `Route` from `Symfony\Component\Routing\Annotation\Route`, change it to use the new `Symfony\Component\Routing\Attribute\Route`.

There left another two warnings from Doctrine configuration.

Open `config/packages/doctrine.yaml`, add the following two lines.

```yaml
doctrine:
    dbal:
        url: '%env(resolve:DATABASE_URL)%'
        use_savepoints: true  // add this line
        ...
    orm:
        auto_generate_proxy_classes: true
        enable_lazy_ghost_objects: true // add this line
        ...
```

Now run the tests, all tests should be passed.

Finally, we update the PHP version in Github actions workflow file, use PHP 8.2 and 8.3 instead. PHP 8.1 is not supported in the new v7.

The working codes is available via my Github, check out the [symfony-rest-sample](https://github.com/hantsy/symfony-rest-sample) and explore it yourself.
